<!DOCTYPE html>
<html>

<head>
    <title>HandyCam Camera Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #333;
            margin-top: 0;
            text-align: center;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }

        .status.active {
            background: #d4edda;
            color: #155724;
        }

        .status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-start {
            background: #28a745;
            color: white;
        }

        .btn-stop {
            background: #dc3545;
            color: white;
        }

        .btn-switch {
            background: #007bff;
            color: white;
        }

        .btn-refresh {
            background: #6c757d;
            color: white;
        }

        .info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .label {
            font-weight: bold;
            color: #495057;
        }

        .value {
            color: #007bff;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .control-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .control-label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            cursor: pointer;
        }

        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
        }

        .toggle-btn {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: #007bff;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìπ Camera Control</h1>

        <div id="status" class="status inactive">Status: Checking...</div>

        <div id="message" class="message"></div>

        <div class="info" id="info" style="display:none;">
            <div class="info-item">
                <span class="label">Stream Port:</span>
                <span class="value" id="port">-</span>
            </div>
            <div class="info-item">
                <span class="label">Current Camera:</span>
                <span class="value" id="camera">-</span>
            </div>
            <div class="info-item">
                <span class="label">Resolution:</span>
                <span class="value" id="resolution">-</span>
            </div>
            <div class="info-item">
                <span class="label">FPS:</span>
                <span class="value" id="fps">-</span>
            </div>
            <div class="info-item">
                <span class="label">JPEG Quality:</span>
                <span class="value" id="jpegQuality">-</span>
            </div>
        </div>

        <button class="btn-start" onclick="startCamera()">‚ñ∂Ô∏è Start Camera Stream</button>
        <button class="btn-stop" onclick="stopCamera()">‚èπÔ∏è Stop Camera Stream</button>

        <div class="control-group" id="cameraList">
            <div class="control-label">Camera Selection</div>
            <div id="cameraButtons">Loading cameras...</div>
        </div>

        <div class="control-group">
            <div class="control-label">
                <span>FPS: <span id="fpsValue">30</span></span>
            </div>
            <input type="range" id="fpsSlider" min="15" max="60" value="30" onchange="setFps(this.value)">
            <button class="btn-refresh" id="applyFpsBtn" onclick="applyFps()">Apply FPS (restart)</button>
        </div>

        <div class="control-group">
            <div class="control-label">
                <span>JPEG Quality: <span id="jpegValue">85</span>%</span>
            </div>
            <input type="range" id="jpegSlider" min="50" max="100" value="85" onchange="setJpegQuality(this.value)">
            <button class="btn-refresh" id="applyJpegBtn" onclick="applyJpeg()">Apply JPEG (restart)</button>
        </div>

        <div class="control-group" id="avcGroup" style="display:none;">
            <div class="control-label">
                <span>AVC Bitrate (kbps): <span id="avcValue">2000</span></span>
            </div>
            <input type="range" id="avcSlider" min="256" max="8000" step="64" value="2000" onchange="setAvcBitrate(this.value)">
            <button class="btn-refresh" id="applyAvcBtn" onclick="applyAvc()">Apply AVC (restart)</button>
        </div>

        <div class="control-group">
            <div class="control-label">
                <span>Exposure: <span id="exposureValue">0</span></span>
            </div>
            <input type="range" id="exposureSlider" min="-50" max="50" value="0" onchange="setExposure(this.value)">
        </div>
        <div class="control-group">
            <button class="toggle-btn" id="torchBtn" onclick="toggleTorch()">üí° Torch: OFF</button>
            <button class="toggle-btn" id="useAvcBtn" onclick="toggleUseAvc()">üéûÔ∏è Use AVC: OFF</button>
            <div id="torchNote" style="font-size:12px;color:#666;margin-top:6px;display:none;color:darkred">Torch only works while stream is started</div>
            <button class="toggle-btn" id="autoExposureBtn" onclick="toggleAutoExposure()">‚òÄÔ∏è Auto Exposure: ON</button>
        </div>

        <button class="btn-refresh" onclick="checkStatus()">üîÑ Refresh Status</button>
    </div>

    <script>
        let torchEnabled = false;
        let avcEnabled = false;
        let avcBitrate = 2000;

        function showMessage(text, isSuccess) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + (isSuccess ? 'success' : 'error');
            setTimeout(() => msg.className = 'message', 3000);
        }

        async function checkStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();

                const statusEl = document.getElementById('status');
                if (data.streaming === true) {
                    statusEl.textContent = 'üü¢ Camera is Streaming on port ' + data.port;
                    statusEl.className = 'status active';
                    // enable torch control while streaming
                    try { document.getElementById('torchBtn').disabled = false; } catch (_) {}
                    try { document.getElementById('torchNote').style.display = 'none'; } catch (_) {}
                } else {
                    statusEl.textContent = 'üî¥ Camera is Stopped';
                    statusEl.className = 'status inactive';
                    // disable torch control when not streaming
                    try { document.getElementById('torchBtn').disabled = true; } catch (_) {}
                    try { document.getElementById('torchNote').style.display = 'block'; } catch (_) {}
                }
            } catch (e) {
                showMessage('Failed to check status: ' + e.message, false);
            }
        }
        async function checkCameraSettings() {
            try {
                const response = await fetch('/api/camera/status');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                // Streaming state
                if (data.streaming) {
                    document.getElementById('info').style.display = 'block';
                } else {
                    document.getElementById('info').style.display = 'none';
                }

                // Text fields
                document.getElementById('port').textContent = data.port;
                document.getElementById('camera').textContent = data.camera;
                document.getElementById('resolution').textContent =
                    `${data.width}x${data.height}`;
                document.getElementById('fps').textContent = data.fps;
                document.getElementById('jpegQuality').textContent =
                    `${data.jpegQuality}%`;

                // Sliders
                document.getElementById('fpsSlider').value = data.fps;
                document.getElementById('fpsValue').textContent = data.fps;

                document.getElementById('jpegSlider').value = data.jpegQuality;
                document.getElementById('jpegValue').textContent = data.jpegQuality;

                // AVC support: show/hide JPEG vs AVC controls
                avcEnabled = data.useAvc === true;
                avcBitrate = data.avcBitrate || 2000;
                const jpegGroup = document.getElementById('jpegSlider').parentElement;
                const avcGroup = document.getElementById('avcGroup');
                if (avcEnabled) {
                    jpegGroup.style.display = 'none';
                    avcGroup.style.display = '';
                    document.getElementById('avcSlider').value = avcBitrate;
                    document.getElementById('avcValue').textContent = avcBitrate;
                } else {
                    jpegGroup.style.display = '';
                    avcGroup.style.display = 'none';
                }

                document.getElementById('exposureSlider').value = data.exposure;
                document.getElementById('exposureValue').textContent = data.exposure;

                // auto exposure visibility
                const exposureGroup = document.getElementById('exposureSlider').parentElement;
                const autoExposureEnabledLocal = data.autoExposure === true;
                // When auto-exposure is enabled, hide manual exposure slider
                if (autoExposureEnabledLocal) {
                    exposureGroup.style.display = 'none';
                } else {
                    exposureGroup.style.display = '';
                }

                // remember auto flags for UI
                window.autoExposureEnabled = autoExposureEnabledLocal;

                // Toggles
                torchEnabled = data.torchEnabled === true;
                updateToggleButtons();
                updateAvcButton();

            } catch (e) {
                console.error('Failed to check camera settings:', e);
                showMessage('Failed to load camera settings', false);
            }
        }

        function updateToggleButtons() {
            const torchBtn = document.getElementById('torchBtn');
            const autoExposureBtn = document.getElementById('autoExposureBtn');
            const useAvcBtn = document.getElementById('useAvcBtn');

            if (torchEnabled) {
                torchBtn.textContent = 'üí° Torch: ON';
                torchBtn.classList.add('active');
            } else {
                torchBtn.textContent = 'üí° Torch: OFF';
                torchBtn.classList.remove('active');
            }
            if (useAvcBtn) {
                if (avcEnabled) {
                    useAvcBtn.textContent = 'üéûÔ∏è Use AVC: ON';
                    useAvcBtn.classList.add('active');
                } else {
                    useAvcBtn.textContent = 'üéûÔ∏è Use AVC: OFF';
                    useAvcBtn.classList.remove('active');
                }
            }
        }

        function updateAvcButton() {
            const useAvcBtn = document.getElementById('useAvcBtn');
            if (!useAvcBtn) return;
            if (avcEnabled) {
                useAvcBtn.textContent = 'üéûÔ∏è Use AVC: ON';
                useAvcBtn.classList.add('active');
            } else {
                useAvcBtn.textContent = 'üéûÔ∏è Use AVC: OFF';
                useAvcBtn.classList.remove('active');
            }
        }

        async function startCamera() {
            try {
                const response = await fetch('/api/camera/start', { method: 'POST' });
                const data = await response.json();
                showMessage(data.message, data.success);
                if (data.success) setTimeout(checkStatus, 1000);
            } catch (e) {
                showMessage('Failed to start camera: ' + e.message, false);
            }
        }

        async function stopCamera() {
            try {
                const response = await fetch('/api/camera/stop', { method: 'POST' });
                const data = await response.json();
                showMessage(data.message, data.success);
                if (data.success) setTimeout(checkStatus, 1000);
            } catch (e) {
                showMessage('Failed to stop camera: ' + e.message, false);
            }
        }

        async function switchCamera(camera) {
            try {
                const response = await fetch('/api/camera/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ camera })
                });
                const data = await response.json();
                showMessage(data.message, data.success);
                if (data.success) setTimeout(checkStatus, 500);
            } catch (e) {
                showMessage('Failed to switch camera: ' + e.message, false);
            }
        }

        async function setFps(fps) {
            document.getElementById('fpsValue').textContent = fps;
            try {
                const response = await fetch('/api/settings/fps', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fps: parseInt(fps) })
                });
                const data = await response.json();
                if (!data.success) showMessage(data.message, false);
            } catch (e) {
                showMessage('Failed to set FPS: ' + e.message, false);
            }
        }

        async function setJpegQuality(quality) {
            document.getElementById('jpegValue').textContent = quality;
            try {
                const response = await fetch('/api/settings/jpeg-quality', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quality: parseInt(quality) })
                });
                const data = await response.json();
                if (!data.success) showMessage(data.message, false);
            } catch (e) {
                showMessage('Failed to set JPEG quality: ' + e.message, false);
            }
        }

        async function applyFps() {
            const btn = document.getElementById('applyFpsBtn');
            btn.disabled = true;
            const fps = parseInt(document.getElementById('fpsSlider').value);
            try {
                // ensure setting saved
                await fetch('/api/settings/fps', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fps })
                });
            } catch (e) {
                showMessage('Failed to save FPS: ' + e.message, false);
                btn.disabled = false; return;
            }

            try {
                let resp = await fetch('/api/camera/stop', { method: 'POST' });
                let data = await resp.json();
                if (!data.success) {
                    showMessage('Failed to stop stream: ' + data.message, false);
                    btn.disabled = false; return;
                }

                resp = await fetch('/api/camera/start', { method: 'POST' });
                data = await resp.json();
                showMessage(data.message, data.success);
                if (data.success) setTimeout(checkStatus, 1000);
            } catch (e) {
                showMessage('Failed to restart stream: ' + e.message, false);
            } finally {
                btn.disabled = false;
            }
        }

        async function applyJpeg() {
            const btn = document.getElementById('applyJpegBtn');
            btn.disabled = true;
            const quality = parseInt(document.getElementById('jpegSlider').value);
            try {
                await fetch('/api/settings/jpeg-quality', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quality })
                });
            } catch (e) {
                showMessage('Failed to save JPEG quality: ' + e.message, false);
                btn.disabled = false; return;
            }

            try {
                let resp = await fetch('/api/camera/stop', { method: 'POST' });
                let data = await resp.json();
                if (!data.success) {
                    showMessage('Failed to stop stream: ' + data.message, false);
                    btn.disabled = false; return;
                }

                resp = await fetch('/api/camera/start', { method: 'POST' });
                data = await resp.json();
                showMessage(data.message, data.success);
                if (data.success) setTimeout(checkStatus, 1000);
            } catch (e) {
                showMessage('Failed to restart stream: ' + e.message, false);
            } finally {
                btn.disabled = false;
            }
        }

        async function setExposure(exposure) {
            document.getElementById('exposureValue').textContent = exposure;
            try {
                const response = await fetch('/api/settings/exposure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ exposure: parseInt(exposure) })
                });
                const data = await response.json();
                if (!data.success) showMessage(data.message, false);
            } catch (e) {
                showMessage('Failed to set exposure: ' + e.message, false);
            }
        }

        async function toggleTorch() {
            torchEnabled = !torchEnabled;
            try {
                const response = await fetch('/api/settings/torch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: torchEnabled })
                });
                const data = await response.json();
                if (data.success) {
                    updateToggleButtons();
                } else {
                    torchEnabled = !torchEnabled;
                    updateToggleButtons();
                    showMessage(data.message, false);
                }
            } catch (e) {
                torchEnabled = !torchEnabled;
                updateToggleButtons();
                showMessage('Failed to toggle torch: ' + e.message, false);
            }
        }

        async function toggleUseAvc() {
            avcEnabled = !avcEnabled;
            try {
                const response = await fetch('/api/settings/use-avc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: avcEnabled })
                });
                const data = await response.json();
                if (!data.success) {
                    avcEnabled = !avcEnabled; updateAvcButton(); showMessage(data.message, false); return;
                }
                updateAvcButton();
            } catch (e) {
                avcEnabled = !avcEnabled; updateAvcButton(); showMessage('Failed to set AVC mode: ' + e.message, false);
            }
        }

        function setAvcBitrate(b) {
            avcBitrate = parseInt(b);
            document.getElementById('avcValue').textContent = avcBitrate;
        }

        async function applyAvc() {
            const btn = document.getElementById('applyAvcBtn');
            btn.disabled = true;
            try {
                await fetch('/api/settings/avc-bitrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bitrate: avcBitrate })
                });
            } catch (e) {
                showMessage('Failed to save AVC bitrate: ' + e.message, false);
                btn.disabled = false; return;
            }

            try {
                let resp = await fetch('/api/camera/stop', { method: 'POST' });
                let data = await resp.json();
                if (!data.success) { showMessage('Failed to stop stream: ' + data.message, false); btn.disabled = false; return; }
                resp = await fetch('/api/camera/start', { method: 'POST' });
                data = await resp.json();
                showMessage(data.message, data.success);
                if (data.success) setTimeout(checkStatus, 1000);
            } catch (e) {
                showMessage('Failed to restart stream: ' + e.message, false);
            } finally { btn.disabled = false; }
        }

    

        async function loadCameraList() {
            try {
                const response = await fetch('/api/camera/list');
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const list = await response.json();
                const container = document.getElementById('cameraButtons');
                container.innerHTML = '';
                list.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'toggle-btn';
                    btn.textContent = item.label || item.id;
                    btn.onclick = () => {
                        switchCamera(item.id);
                    };
                    container.appendChild(btn);
                });
            } catch (e) {
                console.error('Failed to load camera list', e);
                const container = document.getElementById('cameraButtons');
                container.textContent = 'Failed to load cameras';
            }
        }

        // Check status and camera settings on load
        checkStatus();
        checkCameraSettings();
        // Load camera list on load
        loadCameraList();
        // Auto-refresh: status + settings every 5 seconds
        setInterval(() => { checkStatus(); checkCameraSettings(); }, 5000);
        // Refresh camera list less frequently (every 15s)
        setInterval(loadCameraList, 15000);
    </script>
</body>

</html>